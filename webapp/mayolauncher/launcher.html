<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MayoLauncher (Beta)</title>
    <link rel="icon" href="assets/favicon.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="snowfall_effect.js"></script>
    <style>
        /* --- Shared Variables (DARK MODE Defaults) --- */
        :root {
            --ui-bg: #202225;          /* Discord Darker */
            --ui-card: #2f3136;        /* Discord Dark */
            --ui-text: #dcddde;        /* Discord Text */
            --ui-header: #ffffff;      /* Discord Header */
            --ui-accent: #5865F2;      /* Discord Accent */
            --ui-accent-hover: #4752C4;

            --app-icon-size: 80px;
        }

        /* --- LIGHT MODE Overrides --- */
        .light-mode {
            --ui-bg: #f2f3f5;          /* Light Background */
            --ui-card: #ffffff;        /* White Cards/Modals */
            --ui-text: #a39e9e;        /* Dark Text */
            --ui-header: #b4b4b4;      /* Black Headers */
            --ui-accent: #5865F2;
            --ui-accent-hover: #4752C4;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--ui-bg); /* Use UI BG variable */
            /* --- Wallpaper --- */
            background-image: url('assets/os/darkend.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--ui-text); /* Use UI Text variable */
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: background-color 0.3s, color 0.3s; /* Smooth theme transition */
        }

        /* Light Mode Specific Wallpaper */
        .light-mode.light-wallpaper {
            background-image: url('assets/os/light-default.png'); /* Assuming a light wallpaper default */
        }
        /* Keep custom wallpaper if set */
        body[style*="background-image"]:not(.light-mode.light-wallpaper) {
            background-image: var(--body-custom-wallpaper, url('assets/os/darkend.jpg'));
        }

        /* --- Status Bar (Top) --- */
        .status-bar {
            width: 100%;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--ui-bg); /* Use UI BG variable */
            /* Ensure the blur uses the variable */
            background: rgba(var(--ui-bg-r, 32), var(--ui-bg-g, 34), var(--ui-bg-b, 37), 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 10;
        }
        .light-mode .status-bar {
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(242, 243, 245, 0.9);
        }
        
        .clock {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--ui-header); /* Use UI Header variable */
        }

        .system-status {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--ui-text);
        }
        .light-mode .system-status {
            color: #72767d; /* Darker secondary text in light mode */
        }


        /* --- Main Launcher Area --- */
        .launcher-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
            animation: fadeIn 0.5s ease-out;
            overflow-y: auto; /* Allow scrolling if many apps */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .greeting {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ui-header);
            margin-bottom: 3rem;
            text-align: center;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .light-mode .greeting {
            text-shadow: none;
        }

        /* --- App Grid --- */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 2.5rem;
            justify-content: center;
            width: 100%;
            max-width: 1000px;
            padding-bottom: 2rem;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--ui-text);
            transition: transform 0.2s, filter 0.2s;
            cursor: pointer;
            background: none;
            border: none;
            position: relative; /* For delete button positioning */
        }

        .app-item:hover {
            transform: translateY(-5px);
            z-index: 5;
        }

        .app-item:hover .app-icon {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            transform: scale(1.05);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .light-mode .app-item:hover .app-icon {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(0,0,0,0.1);
        }


        .app-icon {
            width: var(--app-icon-size);
            height: var(--app-icon-size);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--ui-card); /* Use UI Card variable */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        .light-mode .app-icon {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: var(--ui-card);
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Special Styling for Add Button */
        .app-add .app-icon {
            border: 2px dashed rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2);
        }
        .light-mode .app-add .app-icon {
            border: 2px dashed rgba(0,0,0,0.1);
            background: rgba(0,0,0,0.05);
        }
        .app-add:hover .app-icon {
            border-color: var(--ui-accent);
            background: rgba(88, 101, 242, 0.1);
        }
        .light-mode .app-add:hover .app-icon {
            background: rgba(88, 101, 242, 0.1);
        }

        /* Settings Icon Specifics */
        .app-settings .app-icon { background: linear-gradient(135deg, #4f545c, #36393f); color: white; }
        .light-mode .app-settings .app-icon { background: linear-gradient(135deg, #a7a7a7, #c4c4c4); color: white; }

        .app-label {
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            color: var(--ui-text);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .light-mode .app-label {
             text-shadow: none;
        }

        /* Action Buttons (Delete & Edit) */
        .action-btn {
            position: absolute;
            top: -5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            color: white;
            z-index: 10;
        }
        .light-mode .action-btn {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .app-item:hover .action-btn {
            opacity: 1;
        }

        /* Delete specific */
        .delete-btn {
            right: -5px;
            background: #ed4245;
        }

        /* Edit specific */
        .edit-btn {
            right: 25px; /* Position next to delete button */
            background: var(--ui-accent);
        }

        /* --- Footer / Dock Area --- */
        .dock-area {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .return-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--ui-text);
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .light-mode .return-btn {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--ui-text);
        }
        .return-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .light-mode .return-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* --- Modals (Settings & Add App) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--ui-card); /* Use UI Card variable */
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.3s;
        }
        .light-mode .modal-content {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .modal-content h2 {
            color: var(--ui-header);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .light-mode .form-group label {
            color: var(--ui-text);
        }

        .form-group input, .form-group select {
            background: var(--ui-bg); /* Use UI BG variable */
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--ui-text);
            padding: 0.75rem;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            width: 100%;
        }
        .light-mode .form-group input, .light-mode .form-group select {
            background: #e9ecef;
            border: 1px solid #ced4da;
            color: var(--ui-text);
        }

        .file-upload-wrapper {
            border: 2px dashed rgba(255,255,255,0.1);
            padding: 1rem;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .light-mode .file-upload-wrapper {
             border: 2px dashed rgba(0,0,0,0.1);
             background: #f8f9fa;
        }
        .file-upload-wrapper:hover {
            border-color: var(--ui-accent);
            background: rgba(255,255,255,0.05);
        }
        .light-mode .file-upload-wrapper:hover {
            background: rgba(88, 101, 242, 0.05);
        }

        .modal-btn {
            background: var(--ui-accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 1rem;
            font-weight: 600;
            width: 100%;
        }
        .modal-btn:hover {
            background: var(--ui-accent-hover);
        }
        .btn-secondary {
            background: #4f545c;
        }
        .light-mode .btn-secondary {
            background: #adb5bd;
            color: var(--ui-text);
        }
        .btn-secondary:hover {
            background: #36393f;
        }
        .light-mode .btn-secondary:hover {
            background: #6c757d;
        }


        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--ui-text);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .close-btn:hover {
            opacity: 1;
        }

        /* Settings Specific Info */
        .settings-info {
            background: var(--ui-bg); /* Use UI BG variable */
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s;
        }
        .light-mode .settings-info {
            background: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align items vertically */
            margin-bottom: 0.75rem; /* Increased spacing */
        }
        .settings-row:last-child {
            margin-bottom: 0;
        }
        .settings-label {
            color: var(--ui-text);
            font-weight: 600;
        }
        .light-mode .settings-label {
             color: var(--ui-text);
        }
        .settings-value {
            color: var(--ui-text);
            font-family: monospace;
        }

        /* Toggle Switch Styling */
        .toggle-switch-container {
            display: flex;
            align-items: center;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--ui-accent);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--ui-accent);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }


        /* Responsive */
        @media (max-width: 600px) {
            .app-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
            :root {
                --app-icon-size: 60px;
            }
            .greeting {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>

    <!-- Top Status Bar -->
    <div class="status-bar">
        <div class="clock" id="clock">12:00 PM</div>
        <div class="system-status">
            <span>MAYO OS</span>
            <span style="opacity: 0.5;">|</span>
            <span id="date">Oct 24</span>
        </div>
    </div>

    <!-- Main Launcher Interface -->
    <div class="launcher-container">
        <h1 class="greeting">Welcome Back!</h1>
        
        <div class="app-grid" id="app-grid">
            <!-- Dynamic Apps will be injected here -->
        </div>
    </div>

    <!-- Dock / Footer -->
    <div class="dock-area">
        <a href="../../index.html" class="return-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            mayonaise.gg
        </a>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button onclick="closeSettings()" class="close-btn">&times;</button>
            <h2>Settings</h2>
            
            <div class="settings-info">
                <div class="settings-row">
                    <span class="settings-label">OS Version:</span>
                    <span class="settings-value" id="os-version-display">--</span>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Storage Used:</span>
                    <span class="settings-value" id="storage-used-display">Calculating...</span>
                </div>
                
                <!-- NEW: Light Mode Toggle -->
                <div class="settings-row">
                    <span class="settings-label">Light Mode</span>
                    <div class="toggle-switch-container">
                        <label class="switch">
                            <input type="checkbox" id="light-mode-toggle" onchange="toggleLightMode(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

            </div>

            <div class="form-group">
                <label for="wallpaper-url">Custom Wallpaper URL</label>
                <input type="text" id="wallpaper-url" placeholder="https://example.com/image.png">
            </div>
            <button id="save-wallpaper-btn" class="modal-btn">Apply Wallpaper</button>
            <button id="reset-wallpaper-btn" class="modal-btn btn-secondary" style="margin-top: 0.5rem;">Reset to Default</button>
        </div>
    </div>

    <!-- Add/Edit Shortcut Modal -->
    <div id="add-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button onclick="closeAddModal()" class="close-btn">&times;</button>
            <h2 id="modal-title">Add Shortcut</h2>
            
            <div class="form-group">
                <label for="app-name">App Name</label>
                <input type="text" id="app-name" placeholder="e.g. My Site">
            </div>

            <div class="form-group">
                <label for="app-url">URL / Link</label>
                <input type="text" id="app-url" placeholder="https://google.com">
            </div>

            <div class="form-group">
                <label>App Icon (Image)</label>
                <div class="file-upload-wrapper" onclick="document.getElementById('app-icon-file').click()">
                    <span id="file-label">Click to upload image</span>
                    <input type="file" id="app-icon-file" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
                </div>
                <div style="text-align: center; margin-top: 5px; font-size: 0.8rem; opacity: 0.7;">OR</div>
                <input type="text" id="app-icon-url" placeholder="Image URL (optional)" style="margin-top: 5px;">
            </div>

            <button onclick="saveShortcut()" class="modal-btn" id="modal-save-btn">Add Shortcut</button>
        </div>
    </div>

    <script>
        // --- Constants ---
        const OS_VERSION = 'MAYO OS v1.0.1';
        const DEFAULT_DARK_WALLPAPER = 'assets/os/darkend.jpg';
        const DEFAULT_LIGHT_WALLPAPER = 'assets/os/light-default.png';
        
        // Helper to convert CSS variable RGB values for backdrop-filter approximation
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
        }
        
        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString([], { month: 'short', day: 'numeric' });
            
            document.getElementById('clock').textContent = timeString;
            document.getElementById('date').textContent = dateString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Data Management (Local Storage) ---
        let shortcuts = JSON.parse(localStorage.getItem('myShortcuts')) || [];
        
        // --- DOM Elements ---
        const appGrid = document.getElementById('app-grid');
        const settingsModal = document.getElementById('settings-modal');
        const addModal = document.getElementById('add-modal');
        const wallpaperInput = document.getElementById('wallpaper-url');
        
        // --- State Variables ---
        let editingIndex = -1; // -1 means creating new, >=0 means editing existing

        // --- Theme Logic ---
        function applyWallpaper(url) {
            const body = document.body;
            body.style.backgroundImage = `url('${url}')`;
            // Save current wallpaper URL in a variable for reference, separate from the CSS property
            body.style.setProperty('--body-custom-wallpaper', `url('${url}')`);
        }

        function toggleLightMode(isLight) {
            const body = document.body;
            const toggle = document.getElementById('light-mode-toggle');

            if (isLight) {
                body.classList.add('light-mode');
                localStorage.setItem('themePreference', 'light');
                toggle.checked = true;
                
                // If using default wallpaper, switch to light default
                if (!localStorage.getItem('customWallpaper')) {
                    applyWallpaper(DEFAULT_LIGHT_WALLPAPER);
                    body.classList.add('light-wallpaper'); // Add class to use light default CSS
                }
            } else {
                body.classList.remove('light-mode');
                localStorage.setItem('themePreference', 'dark');
                toggle.checked = false;
                
                // If using default wallpaper, switch back to dark default
                if (!localStorage.getItem('customWallpaper')) {
                    applyWallpaper(DEFAULT_DARK_WALLPAPER);
                    body.classList.remove('light-wallpaper');
                }
            }
        }
        
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('themePreference') || 'dark';
            // Set the state of the toggle without firing the change event
            const isLight = savedTheme === 'light';
            
            // Set the toggle state first
            const toggle = document.getElementById('light-mode-toggle');
            if (toggle) {
                 toggle.checked = isLight;
            }
            
            // Apply the theme
            toggleLightMode(isLight);
        }

        // --- Render Apps ---
        function renderApps() {
            appGrid.innerHTML = '';

            // 1. Render Custom Shortcuts
            shortcuts.forEach((app, index) => {
                const div = document.createElement('div');
                div.className = 'app-item';
                div.onclick = (e) => {
                    // Prevent navigation if clicking buttons
                    if(!e.target.closest('.action-btn')) {
                        window.location.href = app.url;
                    }
                };

                // Determine icon source (Base64 or URL or SVG Fallback)
                let iconContent;
                if (app.icon) {
                    iconContent = `<img src="${app.icon}" alt="${app.name}" style="border-radius: 22px;">`;
                } else {
                    iconContent = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
                }

                div.innerHTML = `
                    <div class="app-icon">
                        ${iconContent}
                    </div>
                    <span class="app-label">${app.name}</span>
                    <button class="action-btn delete-btn" onclick="deleteShortcut(${index}, event)" title="Remove App">&times;</button>
                    <button class="action-btn edit-btn" onclick="editShortcut(${index}, event)" title="Edit App">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                `;
                appGrid.appendChild(div);
            });

            // 2. Render "Settings" App
            const settingsBtn = document.createElement('button');
            settingsBtn.className = 'app-item app-settings';
            settingsBtn.onclick = openSettings;
            settingsBtn.innerHTML = `
                <div class="app-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.82.33z"></path></svg>
                </div>
                <span class="app-label">Settings</span>
            `;
            appGrid.appendChild(settingsBtn);

            // 2. Render "File Manager" App (New Static App)
            const DiscordBtn = document.createElement('a');
            DiscordBtn.className = 'app-item app-discord'; // Optional: Use a custom class for styling
            DiscordBtn.href = 'https://discord.com/'; // <--- **Crucial link to your new page**
            DiscordBtn.innerHTML = `
                <div class="app-icon" style="background: linear-gradient(135deg, #7289DA, #5865F2); color: blue;"> 
                    <img src="assets/app-icons/discord.png" alt="Discord" style="width: 100%; height: 100%; object-fit: cover; border-radius: 22px;">
                </div>
                <span class="app-label">Discord</span>
            `;
            appGrid.appendChild(DiscordBtn);

            // 2. Render "File Manager" App (New Static App)
            const DownloadsBtn = document.createElement('a');
            DownloadsBtn.className = 'app-item app-downloads'; // Optional: Use a custom class for styling
            DownloadsBtn.href = 'resources/downloads/index.html'; // <--- **Crucial link to your new page**
            DownloadsBtn.innerHTML = `
                <div class="app-icon" style="background: linear-gradient(135deg, orange, #ffc107); color: orange;"> 
                    <img src="assets/os/downloads.jpg" alt="Downloads" style="width: 100%; height: 100%; object-fit: cover; border-radius: 22px;">
                </div>
                <span class="app-label">Downloads</span>
            `;
            appGrid.appendChild(DownloadsBtn);

            // 2. Render "File Manager" App (New Static App)
            const SpotifyBtn = document.createElement('a');
            SpotifyBtn.className = 'app-item app-spotify'; // Optional: Use a custom class for styling
            SpotifyBtn.href = 'https://spotify.com/'; // <--- **Crucial link to your new page**
            SpotifyBtn.innerHTML = `
                <div class="app-icon" style="background: linear-gradient(135deg, #1db954, #1ed760); color: green;"> 
                    <img src="assets/app-icons/spotify.png" alt="Spotify" style="width: 100%; height: 100%; object-fit: cover; border-radius: 22px;">
                </div>
                <span class="app-label">Spotify</span>
            `;
            appGrid.appendChild(SpotifyBtn);

            // 3. Render "Add App" Button
            const addBtn = document.createElement('button');
            addBtn.className = 'app-item app-add';
            addBtn.onclick = openAddModal;
            addBtn.innerHTML = `
                <div class="app-icon" style="color: var(--ui-text);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </div>
                <span class="app-label">Add Shortcut</span>
            `;
            appGrid.appendChild(addBtn);
        }

        // --- Add/Edit Logic (omitted for brevity, no changes) ---
        let tempIconBase64 = '';

        function openAddModal() {
            // Reset for "Create" mode
            editingIndex = -1;
            document.getElementById('modal-title').textContent = 'Add Shortcut';
            document.getElementById('modal-save-btn').textContent = 'Add Shortcut';
            
            // Clear fields
            document.getElementById('app-name').value = '';
            document.getElementById('app-url').value = '';
            document.getElementById('app-icon-url').value = '';
            document.getElementById('app-icon-file').value = '';
            document.getElementById('file-label').textContent = 'Click to upload image';
            tempIconBase64 = '';
            
            addModal.style.display = 'flex';
        }

        function editShortcut(index, event) {
            event.stopPropagation(); // Stop from opening app
            
            // Set "Edit" mode
            editingIndex = index;
            const app = shortcuts[index];
            
            document.getElementById('modal-title').textContent = 'Edit Shortcut';
            document.getElementById('modal-save-btn').textContent = 'Save Changes';
            
            // Fill fields
            document.getElementById('app-name').value = app.name;
            document.getElementById('app-url').value = app.url;
            
            // Icon handling is tricky because we don't know if it was file or URL
            // We just clear inputs and let them set new ones if they want, 
            // but we keep the current icon in temp variable so it doesn't get lost
            // if they don't touch the icon fields.
            tempIconBase64 = app.icon;
            document.getElementById('file-label').textContent = 'Change image (Current icon retained)';
            document.getElementById('app-icon-url').value = ''; 

            addModal.style.display = 'flex';
        }

        function closeAddModal() {
            addModal.style.display = 'none';
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Limit file size
                // Custom alert function should be used instead of standard alert
                const showCustomAlert = (message) => {
                     // In a real application, replace this with a styled modal/toast
                     console.error(message);
                     alert(message); 
                }

                if (file.size > 2000000) {
                    showCustomAlert('Image file is too large! Please choose an image under 2MB.');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    tempIconBase64 = e.target.result;
                    document.getElementById('file-label').textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveShortcut() {
            const name = document.getElementById('app-name').value.trim();
            let url = document.getElementById('app-url').value.trim();
            const iconUrl = document.getElementById('app-icon-url').value.trim();
            
            const showCustomAlert = (message) => {
                 // In a real application, replace this with a styled modal/toast
                 console.error(message);
                 alert(message); 
            }

            if (!name || !url) {
                showCustomAlert('Please provide at least a Name and a URL.');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            // Logic: If user uploaded a new URL, use it.
            // If user uploaded a new File, use it (tempIconBase64 updated).
            // If user did neither, tempIconBase64 holds the OLD icon (in edit mode) or empty (add mode).
            // However, if iconUrl is provided, it takes precedence over temp/old icon.
            let finalIcon = tempIconBase64; 
            if (iconUrl) {
                finalIcon = iconUrl;
            }

            const newShortcut = { name, url, icon: finalIcon || '' };

            if (editingIndex >= 0) {
                // Update existing
                shortcuts[editingIndex] = newShortcut;
            } else {
                // Add new
                shortcuts.push(newShortcut);
            }

            localStorage.setItem('myShortcuts', JSON.stringify(shortcuts));
            
            renderApps();
            closeAddModal();
        }

        function deleteShortcut(index, event) {
            event.stopPropagation();
            if(confirm('Delete this shortcut?')) {
                shortcuts.splice(index, 1);
                localStorage.setItem('myShortcuts', JSON.stringify(shortcuts));
                renderApps();
            }
        }

        // --- Settings Logic ---
        function openSettings() {
            updateStorageDisplay();
            document.getElementById('os-version-display').textContent = OS_VERSION;
            settingsModal.style.display = 'flex';
        }

        function updateStorageDisplay() {
            let total = 0;
            for (let x in localStorage) {
                if (!localStorage.hasOwnProperty(x)) continue;
                total += ((localStorage[x].length + x.length) * 2); // approximate size in bytes
            }
            
            // Convert to KB
            const kb = (total / 1024).toFixed(2);
            document.getElementById('storage-used-display').textContent = `${kb} KB`;
        }

        function closeSettings() {
            settingsModal.style.display = 'none';
        }

        document.getElementById('save-wallpaper-btn').addEventListener('click', () => {
            const newWallpaperUrl = wallpaperInput.value.trim();
            const showCustomAlert = (message) => {
                 // In a real application, replace this with a styled modal/toast
                 console.error(message);
                 alert(message); 
            }
            if (newWallpaperUrl) {
                applyWallpaper(newWallpaperUrl);
                localStorage.setItem('customWallpaper', newWallpaperUrl);
                // Remove the light-wallpaper class as custom wallpapaer overrides
                document.body.classList.remove('light-wallpaper'); 
                closeSettings();
            } else {
                showCustomAlert('Please enter a valid URL.');
            }
        });

        document.getElementById('reset-wallpaper-btn').addEventListener('click', () => {
            const currentTheme = localStorage.getItem('themePreference') || 'dark';
            
            if (currentTheme === 'light') {
                applyWallpaper(DEFAULT_LIGHT_WALLPAPER);
                document.body.classList.add('light-wallpaper');
            } else {
                applyWallpaper(DEFAULT_DARK_WALLPAPER);
                document.body.classList.remove('light-wallpaper');
            }

            localStorage.removeItem('customWallpaper');
            wallpaperInput.value = '';
            closeSettings();
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Must load theme preference before loading wallpaper, as wallpaper depends on theme
            loadThemePreference();

            // Load Custom Wallpaper (this will override theme default if present)
            const savedWallpaper = localStorage.getItem('customWallpaper');
            if (savedWallpaper) {
                applyWallpaper(savedWallpaper);
            }
            
            // Initial Render
            renderApps();
        });
    </script>
</body>

</html>
